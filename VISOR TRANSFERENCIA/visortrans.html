<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Monitoreo de Transferencias</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root{
      --azul:#00416A; --resalte:#0c6cbd;
      --bg-grad:linear-gradient(to right,#00416A,#E4E5E6);
      --card:rgba(255,255,255,.9);
      --shadow:0 6px 18px rgba(0,0,0,.18);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:'Poppins',sans-serif;
      min-height:100vh;
      background:var(--bg-grad);
      display:flex; flex-direction:column;
      align-items:center; padding:20px;
      position:relative;
    }
    body::before{
      content:""; background:url('logo_proveedora.webp') center/600px no-repeat;
      opacity:.07; position:absolute; inset:0; z-index:0;
    }
    h1{
      color:#fff; font-size:1.8rem; text-align:center;
      margin-bottom:25px; z-index:1;
    }
    .contenedor{
      width:95%; max-width:900px; position:relative; z-index:1;
    }
    .tarjeta{
      background:var(--card); border-radius:var(--radius);
      box-shadow:var(--shadow); margin-bottom:20px; padding:18px;
      cursor:pointer; transition:.2s;
    }
    .tarjeta:hover{transform:scale(1.01);}
    .tarjeta-header{
      display:flex; justify-content:space-between; align-items:center;
      color:var(--azul); font-weight:600;
    }
    .detalles{margin-top:10px; display:none;}
    table{width:100%; border-collapse:collapse; margin-top:8px;}
    th,td{border:1px solid #ddd; padding:6px; text-align:left;}
    th{background:#f3f6fa;}
    .btnImprimir{
      background:var(--resalte); color:#fff; border:none;
      padding:6px 12px; border-radius:8px; font-weight:600;
      cursor:pointer; margin-top:10px;
    }
    .btnImprimir:hover{opacity:.9;}
    @media print {
      body{background:#fff;}
      .tarjeta{box-shadow:none; border:none;}
      .btnImprimir, h1 {display:none;}
    }
  </style>
</head>
<body>
  <h1>Monitoreo de Transferencias</h1>
  <div class="contenedor" id="contenedor"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    // Configuración Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.firebasestorage.app",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const contenedor = document.getElementById('contenedor');

    // Cargar transferencias
    async function cargarTransferencias(){
      const q = query(collection(db,"transferencias"), orderBy("fecha","desc"));
      const snap = await getDocs(q);
      contenedor.innerHTML = "";
      if(snap.empty){
        contenedor.innerHTML = "<p style='color:white;text-align:center;'>No hay transferencias registradas.</p>";
        return;
      }

      snap.forEach(doc=>{
        const t = doc.data();
        const div = document.createElement('div');
        div.className = "tarjeta";
        div.innerHTML = `
          <div class="tarjeta-header">
            <span>Folio: ${t.folio}</span>
            <span>${t.sucursal || "—"}</span>
          </div>
          <div class="detalles">
            <table>
              <thead><tr><th>Código</th><th>Descripción</th><th>Cantidad</th><th>Costo</th></tr></thead>
              <tbody>
                ${(t.items||[]).map(i=>`
                  <tr>
                    <td>${i.codigo}</td>
                    <td>${i.descripcion}</td>
                    <td>${i.cantidad}</td>
                    <td>${i.costo.toFixed(2)}</td>
                  </tr>`).join('')}
              </tbody>
            </table>
            <button class="btnImprimir">Imprimir</button>
          </div>
        `;
        const detalles = div.querySelector('.detalles');
        const btn = div.querySelector('.btnImprimir');
        div.addEventListener('click', e=>{
          if(e.target.classList.contains('btnImprimir')) return;
          detalles.style.display = detalles.style.display==='block' ? 'none' : 'block';
        });
        btn.addEventListener('click', e=>{
          e.stopPropagation();
          imprimirTransferencia(t);
        });
        contenedor.appendChild(div);
      });
    }

    // Vista limpia para imprimir
    function imprimirTransferencia(data){
      const w = window.open('', '_blank');
      w.document.write(`
        <html><head>
        <title>${data.folio}</title>
        <style>
          body{font-family:Poppins,sans-serif;padding:20px;}
          h2{text-align:center;}
          .logo{display:block;margin:0 auto 10px auto;height:70px;}
          table{width:100%;border-collapse:collapse;margin-top:10px;}
          th,td{border:1px solid #999;padding:6px;text-align:left;}
          th{background:#f3f6fa;}
        </style>
        </head><body>
          <img src="logo_proveedora.webp" class="logo" alt="Logo"/>
          <h2>Solicitud de Transferencia</h2>
          <p><strong>Folio:</strong> ${data.folio}<br>
          <strong>Sucursal:</strong> ${data.sucursal}<br>
          <strong>Fecha:</strong> ${new Date(data.fecha).toLocaleString('es-MX')}</p>
          <table>
            <thead><tr><th>Código</th><th>Descripción</th><th>Cantidad</th><th>Costo</th></tr></thead>
            <tbody>
              ${(data.items||[]).map(i=>`
                <tr>
                  <td>${i.codigo}</td>
                  <td>${i.descripcion}</td>
                  <td>${i.cantidad}</td>
                  <td>${i.costo.toFixed(2)}</td>
                </tr>`).join('')}
            </tbody>
          </table>
          <script>window.print();<\/script>
        </body></html>
      `);
      w.document.close();
    }

    cargarTransferencias();
  </script>
</body>
</html>

